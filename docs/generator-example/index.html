<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foe Foundry Monster Generator</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="generator.css" />
    <!-- <link rel="stylesheet" href="raty.css" /> -->
    <link rel="stylesheet" href="../css/site.css" />
</head>


<body>
    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- Monster Card Panel -->
            <div class="col-md-5 position-relative">
                <monster-card monster-key="skeleton"></monster-card>
                <monster-card monster-key="basilisk"></monster-card>
                <monster-card monster-key="gelatinous-cube"></monster-card>
                <monster-card monster-key="knight"></monster-card>
                <monster-card monster-key="frost-giant"></monster-card>
            </div>
            <!-- Statblock Panel -->
            <div class="col-md-7">
                <div id="statblock-holder"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="src/main.ts"></script>
    <script>

        const statblockHolder = document.getElementById('statblock-holder');

        document.querySelectorAll('monster-card').forEach(card => {
            card.addEventListener('monster-changed', async (event) => {
                const monsterCard = event.detail.monsterCard;
                if (!monsterCard) return;

                console.log(event);

                // Get selected powers
                const selectedPowers = monsterCard.getSelectedPowers().map(p => p?.key).filter(Boolean);
                const monsterKey = monsterCard.monsterKey;
                const hp_multiplier = monsterCard.hpMultiplier;
                const damage_multiplier = monsterCard.damageMultiplier;

                // Build request payload
                const payload = {
                    monster_key: monsterKey,
                    powers: selectedPowers.length ? selectedPowers : undefined,
                    hp_multiplier,
                    damage_multiplier
                };

                // POST to API
                try {
                    const response = await fetch('https://foefoundry.com/api/v1/monsters/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const statblock_html = result["statblock_html"];

                    // Insert HTML into a temporary container for DOM manipulation
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = statblock_html;

                    // Highlight changed powers if present in event.detail.power
                    if (event.detail.power && event.detail.power.key) {
                        const changedKey = event.detail.power.key;
                        // Find all elements with matching data-power-key
                        tempDiv.querySelectorAll(`[data-power-key="${changedKey}"]`).forEach(el => {
                            el.classList.add('power-changed');
                        });
                    }

                    if (event.detail.changeType === 'hp-changed') {
                        // Highlight HP changes
                        tempDiv.querySelectorAll(`[data-statblock-property="hp"]`).forEach(el => {
                            el.classList.add('hp-changed');
                        });
                    }

                    if (event.detail.changeType === 'damage-changed') {
                        // Highlight damage changes
                        tempDiv.querySelectorAll(`[data-statblock-property="attack"]`).forEach(el => {
                            el.classList.add('damage-changed');
                        });
                    }

                    statblockHolder.innerHTML = tempDiv.innerHTML;
                } catch (err) {
                    statblockHolder.innerHTML = `<div class="alert alert-danger">API Error: ${err}</div>`;
                }
            });
        });
    </script>
</body>

</html>